<div class="container mf_container">
  <h1>New event</h1>

  <h3>Where d'ya wanna get your content?</h3>

  Here's where we want links to the various connections available (Facebook, Instagram etc.)

  Initially, if the user is logged in with facebook, it should show their albums - the user can click to select an entire album or click in to browse the album. If the user is NOT logged in with Facebook, then the screen should allow them to choose which social network to connect with or upload their own images.

  <% if current_user %>

  <ul>
    <li>Photos from FB</li>
    <li>Photos from elsewhere</li>
    <li>Upload my own photos</li>
  </ul>
    <div id="FB_albums_container">
      <h3>Here are albums from your facebook profile:</h3>
      <div class="row fb_albums_row">
        <div class="loading_stuff">
          <div class="spinner">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
          </div>
          <div id="albums_loading">Loading facebook albums...</div>
        </div>
        
        <p>Find photos from your friends</p>
        <p>Photos I've been tagged in</p>

      </div>
    </div>

    <div class="row added_photos_row">
      <h3>Photos that will appear in the video:</h3>
    </div>

    <button class="btn mf_btn" id="done_button"><span class="glyphicon glyphicon-film"></span> Done</button>
    <button class="btn mf_btn" id="add_more">Add more</button>
    </div>
  <% else %>
    You are not currently logged in!
  <% end %>
</div>

<script>
  $(function() {

    $('#thumbscontainer').bind('mousewheel', function(e) { // on scroll
      var $div = $('#thumbscontainer');

      // set div scroll top offset to current + extra from this scroll
      $div.scrollLeft($div.scrollLeft() - e.originalEvent.wheelDelta);

      return false; // prevent body scrolling
    });

    moflix = new Object();
    moflix.photos = [];

    // The div contained within the Thumbnails is empty. Here we force the height of it to show the background image
    function thumbnailHeight() {
      div = $('.mf_thumbnail');
      divWidth = div.width();
      div.css('height', divWidth);
    };

    // Ensure the empty divs contain the image backgrounds are responsive
    $( window ).resize(function() {
      thumbnailHeight();
    });

    // Get the user's FB albums and build the view of them
    $.ajax({
        type: "GET",
        url: "/user_albums",
        dataType: "json",
        success: function(data){
            $( ".loading_stuff" ).fadeOut(0);
            for (var i=0;i<data.length;i++)
              { 
                var pictureURL = $.ajax({
                  type: "GET",
                  async: false,
                  url: "/get_picture?pictureid=" + data[i]['cover'],
                  dataType: "json"
                });
                data[i]['cover'] = pictureURL.responseText;
                // build album add and browse buttons
                $('.fb_albums_row').append(
                  "<div class='col-lg-2 col-sm-3 col-xs-6'>" +
                  "<p>" + data[i]['name'] + " (" + data[i]['count'] + ")</p>" +
                  "<div class='thumbnail img-responsive'>" +
                  "<div class='mf_thumbnail' style='background-image: url(" + data[i]['cover'] + ")'><div class='mf_thumb_buttons' id='" + data[i]['id'] +"'><button class='btn btn-default btn-primary'><span class='glyphicon glyphicon-search'></span> Browse photos</button><br/><button class='btn btn-default btn-success add_all'><span class='glyphicon glyphicon-plus'></span> Add all photos</button></div></div></div></div>"
                  // <a href='#' class='btn btn-default btn-info btn-lg'><span class='glyphicon glyphicon-search'></span> Choose pictures</a>
                  );          
              }; // End of for loop
              thumbnailHeight();
              // Set up the click handler for the buttons (have to do this here to ensure it is done AFTER the creation of the divs!)
              $( ".add_all" ).click(function() {
                getAlbumPhotos($(this).parent().attr("id"));
              });       
      } // Close success callback
    }); // Close Ajax call

  }); // Close page load function

  function getAlbumPhotos(albumId) {
    $.ajax({
      type: "GET",
      url: "/photos_by_album?albumid=" + albumId,
      dataType: "json",
      success: function(data){
        // Add each photo in the Ajax response to the moflix.photos array
        for (var i=0;i<data.length;i++)
          {
            var photo = new Object;
            photo.id = data[i]['id'];
            photo.name = data[i]['name'];
            photo.height = data[i]['height'];
            photo.width = data[i]['width'];
            photo.source = data[i]['source'];
            photo.created = data[i]['created_time'];
            photo.from = data[i]['from']['name'];
            photo.fromid = data[i]['from']['id'];
            photo.comments = data[i]['comments'];
            photo.likes = data[i]['likes'];
            $('.imagelist').append(
              "<li class='thumbimage'><img id='tnimage1' src='"
              + photo.source
              +"'></li>"
            );
            imageListWidth();
            scrollToEnd();

            moflix.photos.push(photo);
          }; // End for loop
      } //End success callback
    }); // End Ajax request
  } // End getAlbumPhotos function


// Creating the event
  $( "#done_button" ).click(function() {
    moflix.username = "<%= current_user.name %>";
    moflix.userid = "<%= current_user.id %>";
    if (true) //$('#event_title').val() == ""
    {
      moflix.title = "A moflix by "+ moflix.username;
    } else {
      moflix.title = "Something else" //$('#event_title').val();
    }

    $.ajax({
      type: "POST",
      url: "/events",
      beforeSend: function(xhr) {
      xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
      },
      dataType: "json",
      data: {
             "event":moflix
             },
      success: function(data){
        alert("Moflix created")
      }
    }); // end of AJAX request

    // convert the event object to JSON, ready to send to Rails with an AJAX call
  }); //End click function

</script>

<!-- Sticky footer for thumbnails -->
<footer class="navbar navbar-fixed-bottom transparent navbar-inverse">
  
  <div class="container">
    <div id="thumbscontainer">
    <ul class="imagelist">
    </div>
  </div>
</footer>

<script>

// This function is for dev only (until FB works on iphone)
$( "#add_more" ).click(function() {
  var photo = new Object;
      photo.id = "none";
      photo.name = "This is the test one";
      photo.height = 720;
      photo.width = 960;
      photo.source = "https://scontent-b-lhr.xx.fbcdn.net/hphotos-prn1/t1.0-9/1017707_10153948172475503_312887545_n.jpg";
      photo.created = "2013-11-01T11:57:48+0000";
      photo.from = "Moflix Test";
      $('.imagelist').append(
        "<li class='thumbimage'><img id='tnimage1' src='"
        + photo.source
        +"'></li>"
      );
      imageListWidth();
      scrollToEnd();
      moflix.photos.push(photo);
      console.log(moflix)
});

// A function to calculate the width of .imagelist
function imageListWidth() {
  var lengthRequired =  (($(".thumbimage").length)*(100+4))+104;  
  $(".imagelist").css("width", lengthRequired)
};

function scrollToEnd() {
  $('#thumbscontainer').scrollLeft($('.imagelist').outerWidth());
};

</script>

